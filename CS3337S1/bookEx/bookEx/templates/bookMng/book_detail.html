{% extends "base.html" %}
{% load static %}

{% block sidenav %}
   {% for item in item_list %}
      <li>
        <a href="{{ item.link }}">  {{ item.item }} </a>
      </li>
   {% endfor %}
{% endblock sidenav %}

{% block content %}
<div style="display: flex; align-items: flex-start; background: rgba(255,255,255,0.8); padding: 20px; border-radius: 15px;">
    <!-- Book Image -->
    <div>
        <img src="{% static book.pic_path %}" alt="Book Image" style="width: 200px; height: auto; border-radius: 10px;">
    </div>

    <!-- Book Info -->
    <div style="margin-left: 30px;">
        <h1>{{ book.name }}</h1>
        <p><strong>Price:</strong> ${{ book.price }}</p>
        <p><strong>Posted by:</strong> {{ book.username }}</p>
        <p><strong>Date:</strong> {{ book.publishdate }}</p>
        <p><strong>Web:</strong> <a href="{{ book.web }}">{{ book.web }}</a></p>
    </div>
</div>

<!-- Rating -->
{% if user.is_authenticated %}
  <form method="post" style="margin-top: 20px;">
    {% csrf_token %}
    <input type="hidden" name="stars" id="stars-input">
    <div style="font-size: 30px;">
      {% for i in "12345"|make_list %}
        <button type="submit" name="stars" value="{{ i }}"
          style="background: none;
          border: none;
          cursor: pointer;
          color: {% if user_rating >= i|add:'0' %}gold{% else %}#ccc{% endif %};">
          ‚òÖ
        </button>
      {% endfor %}
    </div>
  </form>
{% else %}
  <p>
    <a href="{% url 'login' %}" style="color: #003366; font-weight: bold; text-decoration: underline;">
      Login
    </a> to rate this book.
  </p>
{% endif %}

<p style="margin-top: 10px;">
  Average Rating: <strong>{{ avg_rating|floatformat:1 }}</strong> ({{ total_ratings }} rating{{ total_ratings|pluralize }})
</p>

<!-- Favorite -->
{% if user.is_authenticated %}
  <form action="{% url 'toggle_favorite' book_id=book.id %}" method="post" style="margin-top: 20px;">
    {% csrf_token %}
    <button type="submit" style="
      padding: 10px 16px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: {% if is_favorite %}#ffe6e6{% else %}#e6f0ff{% endif %};
      color: {% if is_favorite %}#cc0000{% else %}#003366{% endif %};
      transition: 0.3s;
    ">
      <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
      {% if is_favorite %} Favorited ‚Äî Click to Remove {% else %} Add to Favorites {% endif %}
    </button>
  </form>
{% endif %}

<!-- Comments -->
<div style="margin-top: 30px; margin-bottom: 30px;">
  <h2>Comments</h2>

  {% if comments %}
     <div style="margin-bottom: 20px;">
        {% for comment in comments %}
           <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
              <div style="font-weight: bold;">{{ comment.user.username }}</div>
              <div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">{{ comment.created_date|date:"F j, Y" }}</div>
              <div>{{ comment.text }}</div>

              {% if comment.user == request.user %}
                 <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;" onsubmit="return confirm('Delete this comment?');">
                    {% csrf_token %}
                    <button type="submit" style="
                        background: none;
                        border: none;
                        padding: 0;
                        margin-top: 10px;
                        color: #cc0000;
                        font-weight: bold;
                        cursor: pointer;
                    ">üóëÔ∏è Delete</button>
                 </form>
              {% endif %}
           </div>
        {% endfor %}
     </div>
  {% else %}
     <p>No comments yet. Be the first to comment!</p>
  {% endif %}

  <div style="margin-top: 20px;">
     {% if user.is_authenticated %}
        <form method="post" action="">
           {% csrf_token %}
           <div style="margin-bottom: 10px;">
              {{ comment_form.text }}
           </div>
           <button type="submit" style="
              padding: 8px 16px;
              font-size: 14px;
              font-weight: bold;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              background-color: #e6f0ff;
              color: #003366;
           ">Submit Comment</button>
        </form>
     {% else %}
        <p>
          <a href="{% url 'login' %}" style="color: #003366; font-weight: bold; text-decoration: underline;">
            Login to comment
          </a>
        </p>
     {% endif %}
  </div>
</div>

<br><br>
<a href="{% url 'displaybooks' %}">‚Üê Back to all books</a>
{% endblock content %}
